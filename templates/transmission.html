{% extends "layout.html" %}

{% block head %}
<style>
    .transmission-container {
        background: #000;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .transmission-static {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWPj4+NjY19fX2JiYl/f39ra2uRkZGZmZlpaWmXl5dvb29xcXGTk5NnZ2c8TV1mAAAAG3RSTlNAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAvEOwtAAAFVklEQVR4XpWWB67c2BUFb3g557T/hRo9/WUMZHlgr4Bg8Z4qQgQJlHI4A8SzFVrapvmTF9O7dmYRFZ60YiBhJRCgh1FYhiLAmdvX0CzTOpNE77ME0Zty/nWWzchDtiqrmQDeuv3powQ5ta2eN0FY0InkqDD73lT9c9lEzwUNqgFHs9VQce3TVClFCQrSTfOiYkVJQBmpbq2L6iZavPnAPcoU0dSw0SUTqz/GtrGuXfbyyBniKykOWQWGqwwMA7QiYAxi+IlPdqo+hYHnUt5ZPfnsHJyNiDtnpJyayNBkF6cWoYGAMY92U2hXHF/C1M8uP/ZtYdiuj26UdAdQQSXQErwSOMzt/XWRWAz5GuSBIkwG1H3FabJ2OsUOUhGC6tK4EMtJO0ttC6IBD3kM0ve0tJwMdSfjZo+EEISaeTr9P3wYrGjXqyC1krcKdhMpxEnt5JetoulscpyzhXN5FRpuPHvbeQaKxFAEB6EN+cYN6xD7RYGpXpNndMmZgM5Dcs3YSNFDHUo2LGfZuukSWyUYirJAdYbF3MfqEKmjM+I2EfhA94iG3L7uKrR+GdWD73ydlIB+6hgref1QTlmgmbM3/LeX5GI1Ux1RWpgxpLuZ2+I+IjzZ8wqE4nilvQdkUdfhzI5QDWy+kw5Wgg2pGpeEVeCCA7b85BO3F9DzxB3cdqvBzWcmzbyMiqhzuYqtHRVG2y4x+KOlnyqla8AoWWpuBoYRxzXrfKuILl6SfiWCbjxoZJUaCBj1CjH7GIaDbc9kqBY3W/Rgjda1iqQcOJu2WW+76pZC9QG7M00dffe9hNnseupFL53r8F7YHSwJWUKP2q+k7RdsxyOB11n0xtOvnW4irMMFNV4H0uqwS5ExsmP9AxbDTc9JwgneAT5vTiUSm1E7BSflSt3bfa1tv8Di3R8n3Af7MNWzs49hmauE2wP+ttrq+AsWpFG2awvsuOqbipWHgtuvuaAE+A1Z/7gC9hesnr+7wqCwG8c5yAg3AL1fm8T9AZtp/bbJGwl1pNrE7RuOX7PeMRUERVaPpEs+yqeoSmuOlokqw49pgomjLeh7icHNlG19yjs6XXOMedYm5xH2YxpV2tc0Ro2jJfxC50ApuxGob7lMsxfTbeUv07TyYxpeLucEH1gNd4IKH2LAg5TdVhlCafZvpskfncCfx8pOhJzd76bJWeYFnFciwcYfubRc12Ip/ppIhA1/mSZ/RxjFDrJC5xifFjJpY2Xl5zXdguFqYyTR1zSp1Y9p+tktDYYSNflcxI0iyO4TPBdlRcpeqjK/piF5bklq77VSEaA+z8qmJTFzIWiitbnzR794USKBUaT0NTEsVjZqLaFVqJoPN9ODG70IPbfBHKK+/q/AWR0tJzYHRULOa4MP+W/HfGadZUbfw177G7j/OGbIs8TahLyynl4X4RinF793Oz+BU0saXtUHrVBFT/DnA3ctNPoGbs4hRIjTok8i+algT1lTHi4SxFvONKNrgQFAq2/gFnWMXgwffgYMJpiKYkmW3tTg3ZQ9Jq+f8XN+A5eeUKHWvJWJ2sgJ1Sop+wwhqFVijqWaJhwtD8MNlSBeWNNWTa5Z5kPZw5+LbVT99wqTdx29lMUH4OIG/D86ruKEauBjvH5xy6um/Sfj7ei6UUVk4AIl3MyD4MSSTOFgSwsH/QJWaQ5as7ZcmgBZkzjjU1UrQ74ci1gWBCSGHtuV1H2mhSnO3Wp/3fEV5a+4wz//6qy8JxjZsmxxy5+4w9CDNJY09T072iKG0EnOS0arEYgXqYnXcYHwjTtUNAcMelOd4xpkoqiTYICWFq0JSiPfPDQdnt+4/wuqcXY47QILbgAAAABJRU5ErkJggg==');
        opacity: 0.1;
        pointer-events: none;
    }

    .transmission-header {
        margin-bottom: 2rem;
        position: relative;
        z-index: 1;
    }

    .audio-container {
        background: rgba(0,0,0,0.3);
        padding: 1rem;
        border: 1px solid rgba(255,0,68,0.3);
        margin-bottom: 2rem;
        position: relative;
    }

    .audio-container:before {
        content: "TRANSMISSION";
        position: absolute;
        top: -10px;
        left: 10px;
        background: #000;
        color: #ff0044;
        padding: 0 10px;
        font-size: 0.8rem;
    }

    .audio-player {
        width: 100%;
        margin-bottom: 1rem;
    }

    .audio-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .audio-button {
        background: rgba(255,0,68,0.2);
        border: 1px solid rgba(255,0,68,0.5);
        color: #fff;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background 0.3s;
    }

    .audio-button:hover {
        background: rgba(255,0,68,0.4);
    }

    .spectrogram {
        width: 100%;
        height: 150px;
        background: #000;
        margin-top: 1rem;
        position: relative;
        overflow: hidden;
    }

    .spectrogram-canvas {
        width: 100%;
        height: 100%;
    }

    .morse-container {
        margin-top: 2rem;
        font-family: monospace;
        color: #0f0;
        opacity: 0.7;
    }

    .morse-code {
        margin-top: 0.5rem;
        letter-spacing: 0.2rem;
    }

    .hidden-message {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="transmission-container">
    <div class="transmission-static"></div>

    <div class="transmission-header">
        <h2>INCOMING <span class="glitch-text" data-text="TRANSMISSION">TRANSMISSION</span></h2>
        <p>Intercepted signals from unknown sources. Listen carefully for hidden messages.</p>
    </div>

    <div class="audio-container">
        <audio id="transmission-audio" class="audio-player" controls>
            <source src="{{ url_for('static', filename='audio/transmission.mp3') }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        <div class="audio-controls">
            <button class="audio-button" id="reverse-audio">REVERSE PLAYBACK</button>
            <button class="audio-button" id="slow-audio">SLOW PLAYBACK</button>
            <button class="audio-button" id="analyze-audio">ANALYZE FREQUENCIES</button>
        </div>

        <div class="spectrogram">
            <canvas id="spectrogram-canvas" class="spectrogram-canvas"></canvas>
        </div>
    </div>

    {% if "reversed_audio" in session.get('discovered_secrets', []) %}
    <div class="audio-container">
        <h3>REVERSED TRANSMISSION</h3>
        <audio id="reversed-audio" class="audio-player" controls>
            <source src="{{ url_for('static', filename='audio/transmission-reversed.mp3') }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <p class="hint-text">The message becomes clear when played backwards...</p>
    </div>
    {% endif %}

    {% if "morse_code" in session.get('discovered_secrets', []) %}
    <div class="morse-container">
        <h3>DECODED MORSE SEQUENCE</h3>
        <div class="morse-code">
            ... -.-. .-. .- .--. -.-- .- .-. -.. / .... --- .-.. -.. ... / - .... . / -.- . -.--
        </div>
        <p class="hint-text">Translation: "SCRAPYARD HOLDS THE KEY"</p>
    </div>
    {% endif %}

    <!-- Hidden message in the page -->
    <div class="hidden-message" id="whispers-message">The key is WHISPERS</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audio = document.getElementById('transmission-audio');
        const reverseButton = document.getElementById('reverse-audio');
        const slowButton = document.getElementById('slow-audio');
        const analyzeButton = document.getElementById('analyze-audio');
        const canvas = document.getElementById('spectrogram-canvas');
        const ctx = canvas.getContext('2d');

        // Set canvas dimensions
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // Audio visualization
        let audioContext;
        let analyser;
        let source;
        let isAnalyzing = false;

        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
        }

        // Draw spectrogram
        function drawSpectrogram() {
            if (!isAnalyzing) return;

            requestAnimationFrame(drawSpectrogram);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 255 * canvas.height;

                // Create a gradient color based on frequency
                const hue = i / bufferLength * 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;

                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }

            // Draw hidden message in the spectrogram at specific frequencies
            if (Math.random() < 0.05) {
                ctx.fillStyle = 'rgba(255, 0, 68, 0.7)';
                ctx.font = '10px monospace';
                ctx.fillText('WHISPERS', canvas.width / 2 - 30, canvas.height / 2);
            }
        }

        // Reverse audio playback
        reverseButton.addEventListener('click', function() {
            // In a real implementation, this would actually reverse the audio
            // For this demo, we'll simulate discovering the reversed audio secret
            fetch('/api/discover_secret', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    secret_id: 'reversed_audio'
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    alert('Secret discovered: ' + data.message);
                    console.log('Reward:', data.reward);
                    // Reload the page to show the reversed audio player
                    location.reload();
                }
            });
        });

        // Slow audio playback
        slowButton.addEventListener('click', function() {
            audio.playbackRate = audio.playbackRate === 1.0 ? 0.5 : 1.0;
            slowButton.textContent = audio.playbackRate === 0.5 ? 'NORMAL PLAYBACK' : 'SLOW PLAYBACK';

            // At slow speed, make the hidden message briefly visible
            if (audio.playbackRate === 0.5) {
                const hiddenMessage = document.getElementById('whispers-message');
                hiddenMessage.style.opacity = '0.3';
                hiddenMessage.style.position = 'absolute';
                hiddenMessage.style.top = '50%';
                hiddenMessage.style.left = '50%';
                hiddenMessage.style.transform = 'translate(-50%, -50%)';
                hiddenMessage.style.fontSize = '2rem';
                hiddenMessage.style.color = '#ff0044';
                hiddenMessage.style.zIndex = '100';

                setTimeout(() => {
                    hiddenMessage.style.opacity = '0';
                }, 500);
            }
        });

        // Analyze audio frequencies
        analyzeButton.addEventListener('click', function() {
            initAudioContext();

            if (!isAnalyzing) {
                isAnalyzing = true;
                drawSpectrogram();
                analyzeButton.textContent = 'STOP ANALYSIS';
            } else {
                isAnalyzing = false;
                analyzeButton.textContent = 'ANALYZE FREQUENCIES';
            }
        });

        // Listen for the audio solution
        document.addEventListener('keydown', function(e) {
            if (e.key === 'w' || e.key === 'W') {
                let keySequence = 'w';

                const keyHandler = function(e) {
                    keySequence += e.key.toLowerCase();

                    if (keySequence === 'whispers') {
                        fetch('/api/verify_solution', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                puzzle: 'audio',
                                solution: 'whispers'
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if(data.success) {
                                alert('Puzzle solved: ' + data.message);
                                console.log('Next clue:', data.next_clue);

                                // Also discover the morse code secret
                                fetch('/api/discover_secret', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        secret_id: 'morse_code'
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if(data.success) {
                                        location.reload();
                                    }
                                });
                            }
                        });

                        document.removeEventListener('keydown', keyHandler);
                    }

                    if (keySequence.length > 8) {
                        document.removeEventListener('keydown', keyHandler);
                    }
                };

                document.addEventListener('keydown', keyHandler);
            }
        });
    });
</script>
{% endblock %}